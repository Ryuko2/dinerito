import { createContext, useContext, useState, useCallback, ReactNode } from 'react';

export type Locale = 'es' | 'en';

const STORAGE_KEY = 'sheriff-locale';

export const translations = {
  es: {
    appTitle: 'Sheriff de Gastos',
    appSubtitle: 'Kevin & Angeles',
    add: 'Agregar',
    dashboard: 'Dashboard',
    income: 'Ingresos',
    budgets: 'Presupuestos',
    goals: 'Metas',
    gastometer: 'Gastómetro',
    registerExpense: 'Registrar Gasto',
    paidBy: 'Pagado por',
    amount: 'Monto (MXN)',
    date: 'Fecha',
    description: 'Descripción',
    category: 'Categoría',
    card: 'Tarjeta / Método',
    paymentType: 'Tipo de pago',
    optional: '(opcional)',
    brand: 'Marca / Tienda',
    expenseForSomeone: 'Gasto de alguien más',
    other: 'Otro',
    submitExpense: 'Registrar Gasto',
    saving: 'Guardando...',
    expenseSaved: 'Gasto guardado correctamente',
    expenseSavedDesc: 'Tu gasto ha sido registrado exitosamente.',
    continue: 'Continuar',
    completeRequired: 'Completa los campos obligatorios.',
    errorSaving: 'Error al guardar.',
    selectPersonForThirdParty: 'Selecciona la persona o escribe el nombre.',
    filters: 'Filtros',
    from: 'Desde',
    to: 'Hasta',
    person: 'Persona',
    all: 'Todos',
    allFem: 'Todas',
    expenses: 'Gastos',
    total: 'Total',
    byCategory: 'Por Categoría',
    trend: 'Tendencia',
    noExpenses: 'Sin gastos registrados',
    credit: 'Crédito',
    debit: 'Débito',
    for: 'Para',
    exportData: 'Exportar mis datos',
    importData: 'Importar datos',
    backupDownloaded: 'Respaldo descargado.',
    dataRestored: 'Datos restaurados',
    records: 'registros',
    loading: 'Cargando...',
    errorLoading: 'Error al cargar datos.',
    checkConnection: 'Revisa tu conexión y la configuración de Firebase.',
    showingSaved: 'Mostrando datos guardados. Revisa tu conexión para sincronizar con la nube.',
    addIncome: 'Agregar',
    registerIncome: 'Registrar Ingreso',
    incomes: 'Ingresos',
    balance: 'Saldo',
    newGoal: 'Nueva',
    newBudget: 'Nuevo',
    gastometerTitle: 'Gastómetro',
    gastometerDesc: 'Compara tus gastos con tus ingresos',
    incomeLabel: 'Ingresos',
    expensesLabel: 'Gastos',
    spendingRatio: 'Gastos / Ingresos',
    statusOk: 'Todo bien',
    statusWarm: 'Cuidado',
    statusHot: 'Al límite',
    statusDanger: 'Excedido',
    settings: 'Ajustes',
    settingsDesc: 'Personaliza tu experiencia',
    offlineMsg: 'Sin conexión — los datos se sincronizarán cuando vuelva la conexión',
    syncMsg: 'Mostrando datos guardados. Revisa tu conexión para sincronizar con la nube.',
    errorLoading2: 'Error al cargar datos.',
    checkConnection2: 'Revisa tu conexion y la configuracion de Firebase.',
    dataRecovered: 'Datos recuperados correctamente.',
    errorImporting: 'Error al importar.',
    appName: 'Sheriff de Gastos',
    budgetCreated: 'Presupuesto creado.',
    errorCreating: 'Error al crear.',
    goalCreated: 'Meta creada.',
    errorCreatingGoal: 'Error al crear meta.',
    savingsAdded: 'Ahorro agregado.',
    errorContributing: 'Error al abonar.',
    incomeRegistered: 'Ingreso registrado.',
    expenseDeleted: 'Gasto eliminado.',
    errorUpdating: 'Error al actualizar.',
    errorDeleting: 'Error al eliminar.',
    saving2: 'Guardando...',
    save: 'Guardar',
    registerExpenseBtn: 'Registrar Gasto',
    completeFields: 'Completa los campos obligatorios.',
    selectPerson: 'Selecciona la persona o escribe el nombre.',
    createBudget: 'Crear Presupuesto',
    name: 'Nombre',
    limitMxn: 'Limite (MXN)',
    period: 'Periodo',
    noBudgets: 'Sin presupuestos creados',
    budgetExceeded: 'Presupuesto excedido',
    at80Limit: 'Al 80% del limite',
    trendExceed: 'Tendencia indica que se excedera',
    creating: 'Creando...',
    create: 'Crear',
    allCategories: 'Todas',
    weekly: 'Semanal',
    biweekly: 'Quincenal',
    monthly: 'Mensual',
    icon: 'Icono',
    targetAmount: 'Monto objetivo (MXN)',
    createGoal: 'Crear Meta',
    noGoals: 'Sin metas de ahorro',
    contribute: 'Abonar',
    amountMxn: 'Monto (MXN)',
    concept: 'Concepto',
    history: 'Historial',
    paymentTypeLabel: 'Tipo pago',
    ratio: 'Ratio',
    editExpense: 'Editar Gasto',
    amountLabel: 'Monto',
    deleteExpense: 'Eliminar',
    confirmDeleteExpense: '¿Eliminar este gasto?',
    confirmDeleteDesc: 'Esta acción no se puede deshacer.',
    cancel: 'Cancelar',
    invalidFile: 'Archivo no válido.',
    changesSaved: 'Los cambios han sido guardados exitosamente.',
  },
  en: {
    appTitle: 'Expense Sheriff',
    appSubtitle: 'Kevin & Angeles',
    add: 'Add',
    dashboard: 'Dashboard',
    income: 'Income',
    budgets: 'Budgets',
    goals: 'Goals',
    gastometer: 'Gastometer',
    registerExpense: 'Register Expense',
    paidBy: 'Paid by',
    amount: 'Amount (MXN)',
    date: 'Date',
    description: 'Description',
    category: 'Category',
    card: 'Card / Method',
    paymentType: 'Payment type',
    optional: '(optional)',
    brand: 'Brand / Store',
    expenseForSomeone: 'Expense for someone else',
    other: 'Other',
    submitExpense: 'Register Expense',
    saving: 'Saving...',
    expenseSaved: 'Expense saved successfully',
    expenseSavedDesc: 'Your expense has been registered successfully.',
    continue: 'Continue',
    completeRequired: 'Complete the required fields.',
    errorSaving: 'Error saving.',
    selectPersonForThirdParty: 'Select the person or type the name.',
    filters: 'Filters',
    from: 'From',
    to: 'To',
    person: 'Person',
    all: 'All',
    allFem: 'All',
    expenses: 'Expenses',
    total: 'Total',
    byCategory: 'By Category',
    trend: 'Trend',
    noExpenses: 'No expenses registered',
    credit: 'Credit',
    debit: 'Debit',
    for: 'For',
    exportData: 'Export my data',
    importData: 'Import data',
    backupDownloaded: 'Backup downloaded.',
    dataRestored: 'Data restored',
    records: 'records',
    loading: 'Loading...',
    errorLoading: 'Error loading data.',
    checkConnection: 'Check your connection and Firebase configuration.',
    showingSaved: 'Showing saved data. Check your connection to sync with the cloud.',
    addIncome: 'Add',
    registerIncome: 'Register Income',
    incomes: 'Income',
    balance: 'Balance',
    newGoal: 'New',
    newBudget: 'New',
    gastometerTitle: 'Gastometer',
    gastometerDesc: 'Compare your expenses with your income',
    incomeLabel: 'Income',
    expensesLabel: 'Expenses',
    spendingRatio: 'Expenses / Income',
    statusOk: 'All good',
    statusWarm: 'Careful',
    statusHot: 'At limit',
    statusDanger: 'Exceeded',
    settings: 'Settings',
    settingsDesc: 'Customize your experience',
    offlineMsg: 'Offline — data will sync when connection returns',
    syncMsg: 'Showing saved data. Check your connection to sync with the cloud.',
    errorLoading2: 'Error loading data.',
    checkConnection2: 'Check your connection and Firebase configuration.',
    dataRecovered: 'Data recovered successfully.',
    errorImporting: 'Error importing.',
    appName: 'Expense Sheriff',
    budgetCreated: 'Budget created.',
    errorCreating: 'Error creating.',
    goalCreated: 'Goal created.',
    errorCreatingGoal: 'Error creating goal.',
    savingsAdded: 'Savings added.',
    errorContributing: 'Error contributing.',
    incomeRegistered: 'Income recorded.',
    expenseDeleted: 'Expense deleted.',
    errorUpdating: 'Error updating.',
    errorDeleting: 'Error deleting.',
    saving2: 'Saving...',
    save: 'Save',
    registerExpenseBtn: 'Register Expense',
    completeFields: 'Complete all required fields.',
    selectPerson: 'Select the person or type the name.',
    createBudget: 'Create Budget',
    name: 'Name',
    limitMxn: 'Limit (MXN)',
    period: 'Period',
    noBudgets: 'No budgets created',
    budgetExceeded: 'Budget exceeded',
    at80Limit: 'At 80% of limit',
    trendExceed: 'Trend indicates it will be exceeded',
    creating: 'Creating...',
    create: 'Create',
    allCategories: 'All',
    weekly: 'Weekly',
    biweekly: 'Biweekly',
    monthly: 'Monthly',
    icon: 'Icon',
    targetAmount: 'Target amount (MXN)',
    createGoal: 'Create Goal',
    noGoals: 'No savings goals',
    contribute: 'Contribute',
    amountMxn: 'Amount (MXN)',
    concept: 'Concept',
    history: 'History',
    paymentTypeLabel: 'Payment type',
    ratio: 'Ratio',
    editExpense: 'Edit Expense',
    amountLabel: 'Amount',
    deleteExpense: 'Delete',
    confirmDeleteExpense: 'Delete this expense?',
    confirmDeleteDesc: 'This action cannot be undone.',
    cancel: 'Cancel',
    invalidFile: 'Invalid file.',
    changesSaved: 'Changes have been saved successfully.',
  },
} as const;

type TranslationKey = keyof typeof translations.es;

const I18nContext = createContext<{
  locale: Locale;
  setLocale: (l: Locale) => void;
  t: (key: TranslationKey) => string;
} | null>(null);

export function I18nProvider({ children }: { children: ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY) as Locale | null;
      return stored === 'en' || stored === 'es' ? stored : 'es';
    } catch {
      return 'es';
    }
  });

  const setLocale = useCallback((l: Locale) => {
    setLocaleState(l);
    try {
      localStorage.setItem(STORAGE_KEY, l);
    } catch {}
  }, []);

  const t = useCallback(
    (key: TranslationKey) => translations[locale][key] ?? key,
    [locale]
  );

  return (
    <I18nContext.Provider value={{ locale, setLocale, t }}>
      {children}
    </I18nContext.Provider>
  );
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}
